"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var fontawesome=_interopDefault(require("@fortawesome/fontawesome")),faChartBar=_interopDefault(require("@fortawesome/fontawesome-free-solid/faChartBar")),faChartPie=_interopDefault(require("@fortawesome/fontawesome-free-solid/faChartPie")),faChartLine=_interopDefault(require("@fortawesome/fontawesome-free-solid/faChartLine")),d3a=require("d3-array"),d3s=require("d3-selection"),d3sc=require("d3-scale"),swapTabularVis=_interopDefault(require("swapTabularVis"));function styleInject(e,t){void 0===t&&(t={});var a=t.insertAt;if(e&&"undefined"!=typeof document){var l=document.head||document.getElementsByTagName("head")[0],n=document.createElement("style");n.type="text/css","top"===a&&l.firstChild?l.insertBefore(n,l.firstChild):l.appendChild(n),n.styleSheet?n.styleSheet.cssText=e:n.appendChild(document.createTextNode(e))}}var css="/*tbody*/\n.tab_vis_tbody{\n  cursor: pointer;\n}\n.tab_vis_btn_container{\n  cursor: pointer;\n  position: fixed;\n  width:60px;\n  height: 40px;\n  display: none;\n  box-shadow: 2px 2px 2px grey;\n}\n.tab_vis_btn{\n  position: relative;\n  width: 100%;\n  height: 100%;\n  background-color: #fff;\n  border: 1px solid #c1c1c1;\n  border-radius: 3px;\n}\n.tab_vis_btn:before,.tab_vis_btn:after{\n  content: ' ';\n  width: 0;\n  height: 0;\n  position: absolute;\n  top:4px;\n  left:-12px;\n  border: 6px solid transparent;\n  border-right-color:#fff;\n}\n.tab_vis_btn:before{\n  left:-13px;\n  border-right-color: #c1c1c1;\n}\n.tab_vis_btn div{\n  text-align: center;\n  height: 20px;\n  color:#777;\n  border-bottom:1px solid #d3d3d3;\n}\n.tab_vis_btn div:hover{\n  text-align: center;\n  height: 20px;\n  background: #d3d3d3;\n}\n";styleInject(css);const className={addClass:function(e,t){let a=e.className,l=a+(""==a?"":" ")+t;e.className=l},removeClass:function(e,t){let a=" "+e.className+" ",l=(a=a.replace(/(\s+)/gi," ")).replace(" "+t+" "," ");removedSpace=l.replace(/(^\s+)|(\s+$)/g,""),e.className=removedSpace}};var css$1="@keyframes tabular{ from{ width:0px} to { width:35%} }\n@-webkit-keyframes tabular{ from{ width:0} to { width:35%} }\n@keyframes canvas_key{ from{ height:0} to { height:100%} }\n@-webkit-keyframes canvas_key{ from{ height:0} to { height:100%} }\n.tabular_container_fluid{\n  display:inline-block;\n  position:fixed;\n  margin:auto;\n  top:0;\n  left:0;\n  bottom:0;\n  right:0;\n  width:0;\n  height:0;\n  background:rgba(255,255,255,0.9);\n}\n.tabular_container_fluid .tabular_container{\n  margin:0px auto;\n  text-align: center;\n}\n.tabular_container_fluid .tabular_container canvas{\n    zoom:0.5;\n  }\n.tabular_container_fluid #tabular_vis_btn{\n  margin:0px auto;\n  text-align: center;\n  height: 10%;\n  width: 100%;\n  margin-bottom:10px;\n  overflow: hidden;\n}\n";styleInject(css$1);const insertCss=()=>{fontawesome.library.add(faChartBar),fontawesome.library.add(faChartPie),fontawesome.library.add(faChartLine),console.log("Insert Tabluar-vis Css done!")},canvasBase={setCanvas:function(e,t,a){let l=d3s.select(".tabular_container").append("canvas").attr("width",e).attr("height",t);return"col"==a&&d3s.select(".tabular_container").select("canvas").style("transform","rotate(90deg)"),l},setScale:function(e,t){return d3sc.scaleLinear().range([0,e-20]).domain([0,d3a.max(t)])},setPieScale:function(e){return d3sc.scaleLinear().range([0,2*Math.PI]).domain([0,e])},maxData:function(e){return d3a.max(e)}},barStyle=e=>{let t=e.createLinearGradient(0,200,0,0);t.addColorStop(0,"rgba(110,200,245,1)"),t.addColorStop(1,"rgba(40,125,250,1)");let a=e.createLinearGradient(0,200,0,0);return a.addColorStop(0,"rgba(135,135,135,1)"),a.addColorStop(1,"rgba(0,60,60,1)"),[t,a]},drawBarLine=(e,t,a,l,n)=>{e.beginPath(),e.moveTo(t,a),e.lineTo(l,n),e.closePath(),e.stroke()},drawBarMark=(e,t,a,l,n,r)=>{let i=e.getContext("2d");e.getContext("2d");i.strokeStyle="black";let o=2*parseInt(t/a);0==o&&(o=.5),i.textAlign="right";let d=0,s=n-10;for(i.fillText(0,0,s);d<t;){let e=d+o,a=parseInt(s*(1-e/t));i.moveTo(5,a),i.lineTo(l,a),i.strokeStyle="rgba(135,135,135,0.5)",i.stroke(),i.fillText(e,0,a,15),d+=o}},drawBarRect=(e,t,a,l,n,r,i,o)=>{let d=a/t.length*.8,s=a/t.length*.98;e.font="20px Arial",t.forEach(function(t,a){e.beginPath(),e.rect(s*a+10,l-15,d,-n(t)),a==i?(e.fillStyle=r[0],e.strokeStyle=r[0]):(e.fillStyle=r[1],e.strokeStyle=r[1]),e.fill(),e.closePath(),e.beginPath(),e.fillStyle="rgba(0,0,0,1)",e.textAlign="center",e.fillText(o[a],s*a+10+d/2,l,d),e.fillStyle="rgba(255,255,255,1)",e.fillText(t,s*a+10+d/2,l-n(t)+10,d)})},drawBar=(e,t,a,l)=>{e=e.map(e=>parseFloat(e,10));let n=.6*document.body.clientWidth,r=n,i=document.querySelector(".tabular_container");i.firstElementChild&&i.removeChild(i.firstElementChild);let o=canvasBase.setCanvas(n,r,a),d=o.node().getContext("2d"),s=canvasBase.setScale(r,e),c=canvasBase.maxData(e);d.translate(15,0),drawBarLine(d,5,r-15,n,r-15),drawBarLine(d,5,r-15,5,0),drawBarMark(o.node(),c,e.length,n,r);let u=barStyle(d);drawBarRect(d,e,n,r,s,u,t,l),d.scale(2,2)},bar=function(e,t,a,l){drawBar(e,t,a,l)},drawPieText=(e,t,a,l,n,r)=>{e.fillStyle="white";let i=(n/r).toFixed(2),o=((r-n)/r).toFixed(2),d=(i=i.slice(2,4))+"%",s=(o=o.slice(2,4))+"%";e.fillText(d,t+.5*l,a+.2*l),e.fillText(s,t+.3*l,a-.2*l)},drawPieCircle=(e,t,a,l,n,r,i,o)=>{let d={x:.5*a,y:.5*l,radius:a<l?.3*a:.3*l,focusCircle:n(t[o])};e.beginPath(),e.moveTo(d.x,d.y),e.arc(d.x,d.y,d.radius,0,d.focusCircle),e.fillStyle=i[0],e.closePath(),e.fill(),e.beginPath(),e.moveTo(d.x,d.y),e.arc(d.x,d.y,d.radius,d.focusCircle,2*Math.PI),e.fillStyle=i[1],e.closePath(),e.fill(),drawPieText(e,d.x,d.y,d.radius,t[o],r)},pieStyle=e=>{let t=e.createLinearGradient(0,200,0,0);t.addColorStop(0,"rgba(110,200,245,1)"),t.addColorStop(1,"rgba(40,125,250,1)");let a=e.createLinearGradient(0,200,0,0);return a.addColorStop(0,"rgba(135,135,135,1)"),a.addColorStop(1,"rgba(0,60,60,1)"),[t,a]},drawPie=(e,t)=>{let a=0;e=e.map(e=>(a+=parseFloat(e,10),parseFloat(e,10)));let l=.6*document.body.clientWidth,n=l,r=document.querySelector(".tabular_container");r.firstElementChild&&r.removeChild(r.firstElementChild);let i=canvasBase.setCanvas(l,n).node().getContext("2d"),o=canvasBase.setPieScale(a);i.translate(15,0);let d=pieStyle(i);drawPieCircle(i,e,l,n,o,a,d,t),i.scale(2,2)},pie=function(e,t){drawPie(e,t)},drawLinePath=(e,t,a,l,n,r,i,o)=>{t.forEach(function(d,s){e.beginPath(),s!=t.length-1&&(e.moveTo(a/t.length*s*.92+20,l-15-n(d)),e.lineTo(a/t.length*(s+1)*.92+20,l-15-n(t[s+1])),e.strokeStyle=r[1]),e.closePath(),e.stroke(),e.beginPath(),s==i?(e.arc(a/t.length*s*.92+20,l-15-n(d),10,0,2*Math.PI),e.fillStyle=r[0]):(e.arc(a/t.length*s*.92+20,l-15-n(d),5,0,2*Math.PI),e.fillStyle=r[1]),e.closePath(),e.fill(),e.fillStyle=r[1],e.textAlign="center",e.fillText(o[s],a/t.length*s*.92+25,l,25),e.fillText(d,a/t.length*s*.92+25,l-n(d),25)})},lineStyle=()=>{return["rgba(40,125,250,1)","rgba(0,0,0,1)"]},drawLine=(e,t,a,l)=>{e=e.map(e=>parseFloat(e,10));let n=.6*document.body.clientWidth,r=n,i=document.querySelector(".tabular_container");i.firstElementChild&&i.removeChild(i.firstElementChild);let o=canvasBase.setCanvas(n,r,a),d=o.node().getContext("2d"),s=canvasBase.setScale(r,e),c=canvasBase.maxData(e);return d.translate(15,0),drawBarLine(d,5,r-15,n,r-15),drawBarLine(d,5,r-15,5,0),drawBarMark(o.node(),c,e.length,n,r),drawLinePath(d,e,n,r,s,["rgba(40,125,250,1)","rgba(0,0,0,1)"],t,l),d.scale(2,2),d},line=function(e,t,a,l){drawLine(e,t,a,l)},drawBox=(e,t,a,l,n,r,i,o)=>{e.beginPath(),e.strokeStyle="#000000",e.fillStyle="#000000";let d=l-n(i.max)-10,s=l-n(i.min)-10,c=l-n(i.middle)-10,u=l-n(i.q3)-10,f=n(i.q3-i.q1);e.moveTo(.4*a,d),e.lineTo(.5*a,d),e.fillText(i.max,.7*a,d),e.moveTo(.4*a,s),e.lineTo(.5*a,s),e.fillText(i.min,.7*a,s),e.moveTo(.45*a,d),e.lineTo(.45*a,s),e.stroke(),e.beginPath(),e.strokeStyle="#000",e.fillStyle="#FFF",e.fillRect(.3*a,u,.3*a,f),e.strokeRect(.3*a,u,.3*a,f),e.stroke(),e.beginPath(),e.fillStyle="#000",e.moveTo(.3*a,c),e.lineTo(.6*a,c),e.fillText("middle",.8*a,c),e.stroke(),e.beginPath(),e.strokeStyle="#108AEC",e.fillStyle="#108AEC";let b=l-n(t[r])-10;e.moveTo(.3*a,b),e.lineTo(.6*a,b),e.lineWidth="3",e.font="10",e.fillText(t[r],.8*a,b),e.stroke()},drawBoxPlot=(e,t,a,l,n)=>{e=e.map(e=>parseFloat(e,10));let r=.6*document.body.clientWidth,i=r,o=document.querySelector(".tabular_container");o.firstElementChild&&o.removeChild(o.firstElementChild);let d=canvasBase.setCanvas(r,i,l),s=d.node().getContext("2d"),c=canvasBase.setScale(i,e),u=canvasBase.maxData(e);s.translate(15,0),drawBarLine(s,5,i-15,5,0),drawBarMark(d.node(),u,e.length,r,i),drawBox(s,e,r,i,c,t,a),s.scale(2,2)},quickSort=e=>{if((e=e.map(e=>parseFloat(e,10))).length<=1)return e;{let t=Math.floor(e.length/2)-1,a=e.splice(t,1)[0],l=[],n=[];for(let t=0;t<e.length;t++)e[t]<a?l.push(e[t]):n.push(e[t]);return quickSort(l).concat([a],quickSort(n))}},calcPlot=function(e){let t=e,a=.25*((t=quickSort(t)).length+1),l=t[Math.floor(3*a)],n=t[Math.floor(a)];return{min:t[0],max:t[t.length-1],middle:t[Math.floor(t.length/2)],q3:l,q1:n}},boxPlot=function(e,t,a,l){let n=calcPlot(e);drawBoxPlot(e,t,n,a)},pointStyle=e=>{let t=e.createLinearGradient(0,200,0,0);t.addColorStop(0,"rgba(110,200,245,1)"),t.addColorStop(1,"rgba(40,125,250,1)");let a=e.createLinearGradient(0,200,0,0);return a.addColorStop(0,"rgba(135,135,135,1)"),a.addColorStop(1,"rgba(0,60,60,1)"),[t,a]},drawPointCol=(e,t,a,l,n,r,i,o)=>{let d=a/t.length*.1,s=a/t.length*.92;t.forEach(function(t,a){e.beginPath(),e.arc(s*a+10+d/2,l-15-n(t),2*d,0,2*Math.PI),e.rect(s*a+10,l-15,d,-n(t)+2*d),a==i?(e.fillStyle=r[0],e.strokeStyle=r[0]):(e.fillStyle=r[1],e.strokeStyle=r[1]),e.fill(),e.closePath(),e.beginPath(),e.fillStyle="rgba(0,0,0,1)",e.textAlign="center",e.fillText(o[a],s*a+25,l,25),e.fillStyle="rgba(255,255,255,1)",e.fillText(t,s*a+25,l-n(t),25)})},drawPoint=(e,t,a,l)=>{e=e.map(e=>parseFloat(e,10));let n=.6*document.body.clientWidth,r=n,i=document.querySelector(".tabular_container");i.firstElementChild&&i.removeChild(i.firstElementChild);let o=canvasBase.setCanvas(n,r,a),d=o.node().getContext("2d"),s=canvasBase.setScale(r,e),c=canvasBase.maxData(e);d.translate(15,0),drawBarLine(d,5,r-15,n,r-15),drawBarLine(d,5,r-15,5,0),drawBarMark(o.node(),c,e.length,n,r);let u=pointStyle(d);drawPointCol(d,e,n,r,s,u,t,l),d.scale(2,2)},point=function(e,t,a,l){drawPoint(e,t,a,l)},createIcon=()=>{let e=[],t=document.createElement("i");className.addClass(t,"fa fa-chart-bar"),e.push(t);let a=document.createElement("i");className.addClass(a,"fa fa-chart-pie"),e.push(a);let l=document.createElement("i");return className.addClass(l,"fa fa-chart-line"),e.push(l),e},createDrawButton=()=>{let e=document.createElement("div");e.setAttribute("id","tabular_vis_btn");let t=createIcon(),a=document.createElement("button");a.appendChild(t[0]),a.addEventListener("click",()=>{let e=document.querySelector(".tabular_container_fluid"),t=e.getAttribute("data-on"),a=e.getAttribute("data-index"),l=e.getAttribute("data-title"),n=e.getAttribute("data-status");bar(t.split(","),a,n,l.split(","))}),e.appendChild(a);let l=document.createElement("button");l.appendChild(t[1]),l.addEventListener("click",()=>{let e=document.querySelector(".tabular_container_fluid"),t=e.getAttribute("data-on"),a=e.getAttribute("data-index");pie(t.split(","),a)}),e.appendChild(l);let n=document.createElement("button");n.appendChild(t[2]),n.addEventListener("click",function(){let e=document.querySelector(".tabular_container_fluid"),t=e.getAttribute("data-on"),a=e.getAttribute("data-index"),l=e.getAttribute("data-title"),n=e.getAttribute("data-status");line(t.split(","),a,n,l.split(","))}),e.appendChild(n);let r=document.createElement("button");r.innerHTML="boxPlot",r.addEventListener("click",()=>{let e=document.querySelector(".tabular_container_fluid"),t=e.getAttribute("data-on"),a=e.getAttribute("data-index"),l=e.getAttribute("data-title"),n=e.getAttribute("data-status");boxPlot(t.split(","),a,n,l.split(","))}),e.appendChild(r);let i=document.createElement("button");return i.innerHTML="point",i.addEventListener("click",()=>{let e=document.querySelector(".tabular_container_fluid"),t=e.getAttribute("data-on"),a=e.getAttribute("data-index"),l=e.getAttribute("data-title"),n=e.getAttribute("data-status");point(t.split(","),a,n,l.split(","))}),e.appendChild(i),e},createTabular=()=>{let e=document.createElement("div");className.addClass(e,"tabular_container_fluid");let t=document.createElement("div");return t.setAttribute("id","tabular_vis"),className.addClass(t,"tabular_container"),t.addEventListener("click",()=>{e.removeAttribute("style"),e.style.width="0",t.removeChild(t.firstElementChild)}),e.appendChild(createDrawButton()),e.appendChild(t),document.body.appendChild(e),console.log("Create Tabular div done"),e},regData=e=>{let t=[],a=[],l=new RegExp(/^\d+\.?\d*$/);for(let n=0;n<e[0].length;){let r=e[0][n].innerHTML.replace(/\,/g,"");l.test(r)?(t.push(r),a.push(e[1][n].innerHTML),n++):(e[0].splice(n,1),e[1].splice(n,1))}return{data:t,title:a}},colData=function(e,t){let a=e.parentNode,l=a.parentNode.children,n=[],r=Array.prototype.indexOf.call(a.children,e);for(let e=0;e<l.length;e++)n.push(l[e].children[r]);let i=regData([n,t]);return{data:i.data,title:i.title,index:Array.prototype.indexOf.call(l,a)}},rowData=function(e,t){let a=e.parentNode,l=Array.from(a.children);l.shift();let n=regData([l,t]);return{data:n.data,title:n.title,index:Array.prototype.indexOf.call(l,e)}},initBtn=function(e,t){let a=document.createElement("div"),l=document.createElement("div");className.addClass(a,"tab_vis_btn_container"),className.addClass(l,"tab_vis_btn");let n=document.createElement("div"),r=document.createElement("div");n.innerHTML="ROW",r.innerHTML="COL";return l.appendChild(n),l.appendChild(r),a.appendChild(l),document.body.appendChild(a),n.addEventListener("click",()=>{a.style.display="none";let l=rowData(e.ele,e.rowTitle);t.setAttribute("data-on",l.data),t.setAttribute("data-title",l.title),t.setAttribute("data-index",l.index),t.setAttribute("data-status","row"),swapTabularVis(!1,t),bar(l.data,l.index,"row",l.title)}),r.addEventListener("click",()=>{a.style.display="none";let l=colData(e.ele,e.colTitle);t.setAttribute("data-on",l.data),t.setAttribute("data-title",l.title),t.setAttribute("data-index",l.index),t.setAttribute("data-status","col"),swapTabularVis(!1,t),bar(l.data,l.index,"col",l.title)}),a},colTitle=e=>{if("object"==typeof e){let t=e.querySelector("tbody").children,a=[];for(let e=0;e<t.length;e++)a.push(t[e].children[0]);return a}console.error("the cell bind doesn't come from DOM ")},rowTitle=e=>{if("object"==typeof e){let t=e.querySelector("thead").querySelector("tr");return t=Array.from(t.children),Array.prototype.shift.call(t),t}console.error("the table bind doesn't come from DOM ")},initTable=function(e){let t=e.querySelector("tbody");className.addClass(t,"tab_vis_tbody");let a,l={ele:"",rowTitle:"",colTitle:""};this.initial?a=document.querySelector(".tabular_container_fluid"):(l.rowTitle=rowTitle(e),l.colTitle=colTitle(e),fontawesome.library.add(faChartBar),fontawesome.library.add(faChartPie),fontawesome.library.add(faChartLine),console.log("Insert Tabluar-vis Css done!"),a=createTabular(),this.initial=!0);let n=initBtn(l,a);t.addEventListener("click",()=>{let e=event||window.event,t=e.clientX,a=e.clientY;n.style.left=t+"px",n.style.top=a+"px",n.style.display="block",l.ele=e.target})},table_vis={initial:!1,vis:initTable};module.exports=table_vis;
