"use strict";function _interopDefault(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var d3a=require("d3-array"),d3s=require("d3-selection"),d3sc=require("d3-scale"),swapTabularVis=_interopDefault(require("swapTabularVis"));function styleInject(t,e){void 0===e&&(e={});var a=e.insertAt;if(t&&"undefined"!=typeof document){var n=document.head||document.getElementsByTagName("head")[0],l=document.createElement("style");l.type="text/css","top"===a&&n.firstChild?n.insertBefore(l,n.firstChild):n.appendChild(l),l.styleSheet?l.styleSheet.cssText=t:l.appendChild(document.createTextNode(t))}}var css="/*tbody*/\n.tab_vis_tbody{\n  cursor: pointer;\n}\n.tab_vis_btn_container{\n  cursor: pointer;\n  position: fixed;\n  width:60px;\n  height: 40px;\n  display: none;\n  box-shadow: 2px 2px 2px grey;\n}\n.tab_vis_btn{\n  position: relative;\n  width: 100%;\n  height: 100%;\n  background-color: #fff;\n  border: 1px solid #c1c1c1;\n}\n.tab_vis_btn:before,.tab_vis_btn:after{\n  content: ' ';\n  width: 0;\n  height: 0;\n  position: absolute;\n  top:4px;\n  left:-12px;\n  border: 6px solid transparent;\n  border-right-color:#fff;\n}\n.tab_vis_btn:before{\n  left:-13px;\n  border-right-color: #c1c1c1;\n}\n.tab_vis_btn div{\n  text-align: center;\n  height: 20px;\n  color:#777;\n  border-bottom:1px solid #d3d3d3;\n}\n.tab_vis_btn div:hover{\n  text-align: center;\n  height: 20px;\n  background: #d3d3d3;\n}\n";styleInject(css);const className={addClass:function(t,e){let a=t.className,n=a+(""==a?"":" ")+e;t.className=n},removeClass:function(t,e){let a=" "+t.className+" ",n=(a=a.replace(/(\s+)/gi," ")).replace(" "+e+" "," ");removedSpace=n.replace(/(^\s+)|(\s+$)/g,""),t.className=removedSpace}};var css$1="@keyframes tabular{ from{ width:0px} to { width:30%} }\n@-webkit-keyframes tabular{ from{ width:0} to { width:30%} }\n@keyframes canvas_key{ from{ height:0} to { height:100%} }\n@-webkit-keyframes canvas_key{ from{ height:0} to { height:100%} }\n.tabular_container_fluid{\n  display:inline-block;\n  position:fixed;\n  margin:auto;\n  top:0;\n  left:0;\n  bottom:0;\n  right:0;\n  width:0;\n  height:0;\n  background:rgba(255,255,255,0.9);\n}\n.tabular_container_fluid .tabular_container{\n  margin:0px auto;\n  text-align: center;\n}\n.tabular_container_fluid .tabular_container canvas{\n    zoom:0.5;\n  }\n.tabular_container_fluid #tabular_vis_btn{\n  margin:0px auto;\n  text-align: center;\n  height: 10%;\n  width: 100%;\n  margin-bottom:10px;\n  overflow: hidden;\n}\n";styleInject(css$1);const insertCss=()=>{console.log("Insert Css done!")},canvasBase={setCanvas:function(t,e,a){let n=d3s.select(".tabular_container").append("canvas").attr("width",t).attr("height",e).style("animation","canvas_key 1s").style("WebkitAnimation","canvas_key 1s");return"col"==a&&d3s.select(".tabular_container").select("canvas").style("transform","rotate(90deg)"),n},setScale:function(t,e){return d3sc.scaleLinear().range([0,t-20]).domain([0,d3a.max(e)])},setPieScale:function(t){return d3sc.scaleLinear().range([0,2*Math.PI]).domain([0,t])},maxData:function(t){return d3a.max(t)}},barStyle=t=>{let e=t.createLinearGradient(0,200,0,0);e.addColorStop(0,"rgba(110,200,245,1)"),e.addColorStop(1,"rgba(40,125,250,1)");let a=t.createLinearGradient(0,200,0,0);return a.addColorStop(0,"rgba(135,135,135,1)"),a.addColorStop(1,"rgba(0,60,60,1)"),[e,a]},drawBarLine=(t,e,a,n,l)=>{t.beginPath(),t.moveTo(e,a),t.lineTo(n,l),t.closePath(),t.stroke()},drawBarMark=(t,e,a,n,l,r)=>{let i=t.getContext("2d");t.getContext("2d");i.strokeStyle="black";let o=2*parseInt(e/a);0==o&&(o=.5),i.textAlign="right";let d=0,s=l-10;for(i.fillText(0,0,s);d<e;){let t=d+o,a=parseInt(s*(1-t/e));i.moveTo(5,a),i.lineTo(n,a),i.strokeStyle="rgba(135,135,135,0.5)",i.stroke(),i.fillText(t,0,a,15),d+=o}},drawBarRect=(t,e,a,n,l,r,i,o)=>{let d=a/e.length*.8,s=a/e.length*.92;e.forEach(function(e,a){t.beginPath(),t.rect(s*a+10,n-15,d,-l(e)),a==i?(t.fillStyle=r[0],t.strokeStyle=r[0]):(t.fillStyle=r[1],t.strokeStyle=r[1]),t.fill(),t.closePath(),t.beginPath(),t.fillStyle="rgba(0,0,0,1)",t.textAlign="center",t.fillText(o[a],s*a+25,n,25),t.fillStyle="rgba(255,255,255,1)",t.fillText(e,s*a+25,n-l(e),25)})},drawBar=(t,e,a,n)=>{t=t.map(t=>parseFloat(t,10));let l=.6*document.body.clientWidth,r=l,i=document.querySelector(".tabular_container");i.firstElementChild&&i.removeChild(i.firstElementChild);let o=canvasBase.setCanvas(l,r,a),d=o.node().getContext("2d"),s=canvasBase.setScale(r,t),c=canvasBase.maxData(t);d.translate(15,0),drawBarLine(d,5,r-15,l,r-15),drawBarLine(d,5,r-15,5,0),drawBarMark(o.node(),c,t.length,l,r);let u=barStyle(d);drawBarRect(d,t,l,r,s,u,e,n),d.scale(2,2)},bar=function(t,e,a,n){drawBar(t,e,a,n)},drawPieText=(t,e,a,n,l,r)=>{t.fillStyle="white";let i=(l/r).toFixed(2),o=((r-l)/r).toFixed(2),d=(i=i.slice(2,4))+"%",s=(o=o.slice(2,4))+"%";t.fillText(d,e+.5*n,a+.2*n),t.fillText(s,e+.3*n,a-.2*n)},drawPieCircle=(t,e,a,n,l,r,i,o)=>{let d={x:.5*a,y:.5*n,radius:a<n?.3*a:.3*n,focusCircle:l(e[o])};t.beginPath(),t.moveTo(d.x,d.y),t.arc(d.x,d.y,d.radius,0,d.focusCircle),t.fillStyle=i[0],t.closePath(),t.fill(),t.beginPath(),t.moveTo(d.x,d.y),t.arc(d.x,d.y,d.radius,d.focusCircle,2*Math.PI),t.fillStyle=i[1],t.closePath(),t.fill(),drawPieText(t,d.x,d.y,d.radius,e[o],r)},pieStyle=t=>{let e=t.createLinearGradient(0,200,0,0);e.addColorStop(0,"rgba(110,200,245,1)"),e.addColorStop(1,"rgba(40,125,250,1)");let a=t.createLinearGradient(0,200,0,0);return a.addColorStop(0,"rgba(135,135,135,1)"),a.addColorStop(1,"rgba(0,60,60,1)"),[e,a]},drawPie=(t,e)=>{let a=0;t=t.map(t=>(a+=parseFloat(t,10),parseFloat(t,10)));let n=.6*document.body.clientWidth,l=n,r=document.querySelector(".tabular_container");r.firstElementChild&&r.removeChild(r.firstElementChild);let i=canvasBase.setCanvas(n,l).node().getContext("2d"),o=canvasBase.setPieScale(a);i.translate(15,0);let d=pieStyle(i);drawPieCircle(i,t,n,l,o,a,d,e),i.scale(2,2)},pie=function(t,e){drawPie(t,e)},drawLinePath=(t,e,a,n,l,r,i,o)=>{e.forEach(function(d,s){t.beginPath(),s!=e.length-1&&(t.moveTo(a/e.length*s*.92+20,n-15-l(d)),t.lineTo(a/e.length*(s+1)*.92+20,n-15-l(e[s+1])),t.strokeStyle=r[1]),t.closePath(),t.stroke(),t.beginPath(),s==i?(t.arc(a/e.length*s*.92+20,n-15-l(d),10,0,2*Math.PI),t.fillStyle=r[0]):(t.arc(a/e.length*s*.92+20,n-15-l(d),5,0,2*Math.PI),t.fillStyle=r[1]),t.closePath(),t.fill(),t.fillStyle=r[1],t.textAlign="center",t.fillText(o[s],a/e.length*s*.92+25,n,25),t.fillText(d,a/e.length*s*.92+25,n-l(d),25)})},lineStyle=()=>{return["rgba(40,125,250,1)","rgba(0,0,0,1)"]},drawLine=(t,e,a,n)=>{t=t.map(t=>parseFloat(t,10));let l=.6*document.body.clientWidth,r=l,i=document.querySelector(".tabular_container");i.firstElementChild&&i.removeChild(i.firstElementChild);let o=canvasBase.setCanvas(l,r,a),d=o.node().getContext("2d"),s=canvasBase.setScale(r,t),c=canvasBase.maxData(t);return d.translate(15,0),drawBarLine(d,5,r-15,l,r-15),drawBarLine(d,5,r-15,5,0),drawBarMark(o.node(),c,t.length,l,r),drawLinePath(d,t,l,r,s,["rgba(40,125,250,1)","rgba(0,0,0,1)"],e,n),d.scale(2,2),d},line=function(t,e,a,n){drawLine(t,e,a,n)},drawBox=(t,e,a,n,l,r,i,o)=>{t.beginPath(),t.strokeStyle="#000000",t.fillStyle="#000000";let d=n-l(i.max)-10,s=n-l(i.min)-10,c=n-l(i.middle)-10,u=n-l(i.q3)-10,b=l(i.q3-i.q1);t.moveTo(.4*a,d),t.lineTo(.5*a,d),t.fillText(i.max,.7*a,d),t.moveTo(.4*a,s),t.lineTo(.5*a,s),t.fillText(i.min,.7*a,s),t.moveTo(.45*a,d),t.lineTo(.45*a,s),t.stroke(),t.beginPath(),t.strokeStyle="#000",t.fillStyle="#FFF",t.fillRect(.3*a,u,.3*a,b),t.strokeRect(.3*a,u,.3*a,b),t.stroke(),t.beginPath(),t.fillStyle="#000",t.moveTo(.3*a,c),t.lineTo(.6*a,c),t.fillText("middle",.8*a,c),t.stroke(),t.beginPath(),t.strokeStyle="#108AEC",t.fillStyle="#108AEC";let h=n-l(e[r])-10;t.moveTo(.3*a,h),t.lineTo(.6*a,h),t.lineWidth="3",t.font="10",t.fillText(e[r],.8*a,h),t.stroke()},drawBoxPlot=(t,e,a,n,l)=>{t=t.map(t=>parseFloat(t,10));let r=.6*document.body.clientWidth,i=r,o=document.querySelector(".tabular_container");o.firstElementChild&&o.removeChild(o.firstElementChild);let d=canvasBase.setCanvas(r,i,n),s=d.node().getContext("2d"),c=canvasBase.setScale(i,t),u=canvasBase.maxData(t);s.translate(15,0),drawBarLine(s,5,i-15,5,0),drawBarMark(d.node(),u,t.length,r,i),drawBox(s,t,r,i,c,e,a),s.scale(2,2)},quickSort=t=>{if((t=t.map(t=>parseFloat(t,10))).length<=1)return t;{let e=Math.floor(t.length/2)-1,a=t.splice(e,1)[0],n=[],l=[];for(let e=0;e<t.length;e++)t[e]<a?n.push(t[e]):l.push(t[e]);return quickSort(n).concat([a],quickSort(l))}},calcPlot=function(t){let e=t,a=.25*((e=quickSort(e)).length+1),n=e[Math.floor(3*a)],l=e[Math.floor(a)];return{min:e[0],max:e[e.length-1],middle:e[Math.floor(e.length/2)],q3:n,q1:l}},boxPlot=function(t,e,a,n){let l=calcPlot(t);drawBoxPlot(t,e,l,a)},pointStyle=t=>{let e=t.createLinearGradient(0,200,0,0);e.addColorStop(0,"rgba(110,200,245,1)"),e.addColorStop(1,"rgba(40,125,250,1)");let a=t.createLinearGradient(0,200,0,0);return a.addColorStop(0,"rgba(135,135,135,1)"),a.addColorStop(1,"rgba(0,60,60,1)"),[e,a]},drawPointCol=(t,e,a,n,l,r,i,o)=>{let d=a/e.length*.1,s=a/e.length*.92;e.forEach(function(e,a){t.beginPath(),t.arc(s*a+10+d/2,n-15-l(e),2*d,0,2*Math.PI),t.rect(s*a+10,n-15,d,-l(e)+2*d),a==i?(t.fillStyle=r[0],t.strokeStyle=r[0]):(t.fillStyle=r[1],t.strokeStyle=r[1]),t.fill(),t.closePath(),t.beginPath(),t.fillStyle="rgba(0,0,0,1)",t.textAlign="center",t.fillText(o[a],s*a+25,n,25),t.fillStyle="rgba(255,255,255,1)",t.fillText(e,s*a+25,n-l(e),25)})},drawPoint=(t,e,a,n)=>{t=t.map(t=>parseFloat(t,10));let l=.6*document.body.clientWidth,r=l,i=document.querySelector(".tabular_container");i.firstElementChild&&i.removeChild(i.firstElementChild);let o=canvasBase.setCanvas(l,r,a),d=o.node().getContext("2d"),s=canvasBase.setScale(r,t),c=canvasBase.maxData(t);d.translate(15,0),drawBarLine(d,5,r-15,l,r-15),drawBarLine(d,5,r-15,5,0),drawBarMark(o.node(),c,t.length,l,r);let u=pointStyle(d);drawPointCol(d,t,l,r,s,u,e,n),d.scale(2,2)},point=function(t,e,a,n){drawPoint(t,e,a,n)},createDrawButton=()=>{let t=document.createElement("div");t.setAttribute("id","tabular_vis_btn");let e=document.createElement("button");e.innerHTML="bar",e.addEventListener("click",()=>{let t=document.querySelector(".tabular_container_fluid"),e=t.getAttribute("data-on"),a=t.getAttribute("data-index"),n=t.getAttribute("data-title"),l=t.getAttribute("data-status");bar(e.split(","),a,l,n.split(","))}),t.appendChild(e);let a=document.createElement("button");a.innerHTML="pie",a.addEventListener("click",()=>{let t=document.querySelector(".tabular_container_fluid"),e=t.getAttribute("data-on"),a=t.getAttribute("data-index");pie(e.split(","),a)}),t.appendChild(a);let n=document.createElement("button");n.innerHTML="line",n.addEventListener("click",function(){let t=document.querySelector(".tabular_container_fluid"),e=t.getAttribute("data-on"),a=t.getAttribute("data-index"),n=t.getAttribute("data-title"),l=t.getAttribute("data-status");line(e.split(","),a,l,n.split(","))}),t.appendChild(n);let l=document.createElement("button");l.innerHTML="boxPlot",l.addEventListener("click",()=>{let t=document.querySelector(".tabular_container_fluid"),e=t.getAttribute("data-on"),a=t.getAttribute("data-index"),n=t.getAttribute("data-title"),l=t.getAttribute("data-status");boxPlot(e.split(","),a,l,n.split(","))}),t.appendChild(l);let r=document.createElement("button");return r.innerHTML="point",r.addEventListener("click",()=>{let t=document.querySelector(".tabular_container_fluid"),e=t.getAttribute("data-on"),a=t.getAttribute("data-index"),n=t.getAttribute("data-title"),l=t.getAttribute("data-status");point(e.split(","),a,l,n.split(","))}),t.appendChild(r),t},createTabular=()=>{let t=document.createElement("div");className.addClass(t,"tabular_container_fluid");let e=document.createElement("div");return e.setAttribute("id","tabular_vis"),className.addClass(e,"tabular_container"),e.addEventListener("click",()=>{t.removeAttribute("style"),t.style.width="0",e.removeChild(e.firstElementChild)}),t.appendChild(createDrawButton()),t.appendChild(e),document.body.appendChild(t),console.log("Create Tabular div done"),t},regData=t=>{let e=[],a=[],n=new RegExp(/^\d+\.?\d*$/);for(let l=0;l<t[0].length;){let r=t[0][l].innerHTML.replace(/\,/g,"");n.test(r)?(e.push(r),a.push(t[1][l].innerHTML),l++):(t[0].splice(l,1),t[1].splice(l,1))}return{data:e,title:a}},colData=function(t,e){let a=t.parentNode,n=a.parentNode.children,l=[],r=Array.prototype.indexOf.call(a.children,t);for(let t=0;t<n.length;t++)l.push(n[t].children[r]);let i=regData([l,e]);return{data:i.data,title:i.title,index:Array.prototype.indexOf.call(n,a)}},rowData=function(t,e){let a=t.parentNode,n=Array.from(a.children);n.shift();let l=regData([n,e]);return{data:l.data,title:l.title,index:Array.prototype.indexOf.call(n,t)}},initBtn=function(t,e){let a=document.createElement("div"),n=document.createElement("div");className.addClass(a,"tab_vis_btn_container"),className.addClass(n,"tab_vis_btn");let l=document.createElement("div"),r=document.createElement("div");l.innerHTML="ROW",r.innerHTML="COL";return n.appendChild(l),n.appendChild(r),a.appendChild(n),document.body.appendChild(a),l.addEventListener("click",()=>{a.style.display="none";let n=rowData(t.ele,t.rowTitle);e.setAttribute("data-on",n.data),e.setAttribute("data-title",n.title),e.setAttribute("data-index",n.index),e.setAttribute("data-status","row"),swapTabularVis(!1,e),bar(n.data,n.index,"row",n.title)}),r.addEventListener("click",()=>{a.style.display="none";let n=colData(t.ele,t.colTitle);e.setAttribute("data-on",n.data),e.setAttribute("data-title",n.title),e.setAttribute("data-index",n.index),e.setAttribute("data-status","col"),swapTabularVis(!1,e),bar(n.data,n.index,"col",n.title)}),a},colTitle=t=>{if("object"==typeof t){let e=t.querySelector("tbody").children,a=[];for(let t=0;t<e.length;t++)a.push(e[t].children[0]);return a}console.error("the cell bind doesn't come from DOM ")},rowTitle=t=>{if("object"==typeof t){let e=t.querySelector("thead").querySelector("tr");return e=Array.from(e.children),Array.prototype.shift.call(e),e}console.error("the table bind doesn't come from DOM ")},initTable=function(t){let e=t.querySelector("tbody");className.addClass(e,"tab_vis_tbody");let a,n={ele:"",rowTitle:"",colTitle:""};this.initial?a=document.querySelector(".tabular_container_fluid"):(n.rowTitle=rowTitle(t),n.colTitle=colTitle(t),console.log("Insert Css done!"),a=createTabular(),this.initial=!0);let l=initBtn(n,a);e.addEventListener("click",()=>{let t=event||window.event,e=t.clientX,a=t.clientY;l.style.left=e+"px",l.style.top=a+"px",l.style.display="block",n.ele=t.target})},table_vis={initial:!1,vis:initTable};module.exports=table_vis;
