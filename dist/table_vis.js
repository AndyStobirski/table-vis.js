"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var d3a=require("d3-array"),d3s=require("d3-selection"),d3sc=require("d3-scale"),swapTabularVis=_interopDefault(require("swapTabularVis"));function styleInject(e,t){void 0===t&&(t={});var a=t.insertAt;if(e&&"undefined"!=typeof document){var n=document.head||document.getElementsByTagName("head")[0],r=document.createElement("style");r.type="text/css","top"===a&&n.firstChild?n.insertBefore(r,n.firstChild):n.appendChild(r),r.styleSheet?r.styleSheet.cssText=e:r.appendChild(document.createTextNode(e))}}var css="/*tbody*/\n.tab_vis_tbody{\n  cursor: pointer;\n}\n.tab_vis_btn_container{\n  cursor: pointer;\n  position: fixed;\n  width:60px;\n  height: 40px;\n  display: none;\n  box-shadow: 2px 2px 2px grey;\n}\n.tab_vis_btn{\n  position: relative;\n  width: 100%;\n  height: 100%;\n  background-color: #fff;\n  border: 1px solid #c1c1c1;\n}\n.tab_vis_btn:before,.tab_vis_btn:after{\n  content: ' ';\n  width: 0;\n  height: 0;\n  position: absolute;\n  top:4px;\n  left:-12px;\n  border: 6px solid transparent;\n  border-right-color:#fff;\n}\n.tab_vis_btn:before{\n  left:-13px;\n  border-right-color: #c1c1c1;\n}\n.tab_vis_btn div{\n  text-align: center;\n  height: 20px;\n  color:#777;\n  border-bottom:1px solid #d3d3d3;\n}\n.tab_vis_btn div:hover{\n  text-align: center;\n  height: 20px;\n  background: #d3d3d3;\n}\n";styleInject(css);const className={addClass:function(e,t){let a=e.className,n=a+(""==a?"":" ")+t;e.className=n},removeClass:function(e,t){let a=" "+e.className+" ",n=(a=a.replace(/(\s+)/gi," ")).replace(" "+t+" "," ");removedSpace=n.replace(/(^\s+)|(\s+$)/g,""),e.className=removedSpace}};var css$1="@keyframes tabular{ from{ width:0px} to { width:30%} }\n@-webkit-keyframes tabular{ from{ width:0} to { width:30%} }\n@keyframes canvas_key{ from{ height:0} to { height:100%} }\n@-webkit-keyframes canvas_key{ from{ height:0} to { height:100%} }\n.tabular_container {\n  display:inline-block;position:fixed;\n  margin:auto;top:0;\n  left:0;\n  bottom:0;\n  right:0;\n  width:0;\n  height:0;\n  background:rgba(255,255,255,0.7);\n}\n.tabular_container canvas{\n    zoom:0.5;\n  }\n";styleInject(css$1);const insertCss=()=>{console.log("Insert Css done!")},createTabular=()=>{let e=document.createElement("div");return e.setAttribute("id","tabular_vis"),className.addClass(e,"tabular_container"),e.addEventListener("click",()=>{e.removeAttribute("style"),e.style.width="0",e.removeChild(e.firstElementChild)}),document.body.appendChild(e),console.log("Create Tabular div done"),e},regData=e=>{let t=[],a=[],n=new RegExp(/^\d+\.?\d*$/);for(let r=0;r<e[0].length;){let l=e[0][r].innerHTML.replace(/\,/g,"");n.test(l)?(t.push(l),a.push(e[1][r].innerHTML),r++):(e[0].splice(r,1),e[1].splice(r,1))}return{data:t,title:a}},colData=function(e,t){let a=e.parentNode,n=a.parentNode.children,r=[],l=Array.prototype.indexOf.call(a.children,e);for(let e=0;e<n.length;e++)r.push(n[e].children[l]);let i=regData([r,t]);return{data:i.data,title:i.title,index:Array.prototype.indexOf.call(n,a)}},rowData=function(e,t){let a=e.parentNode,n=Array.from(a.children);n.shift();let r=regData([n,t]);return{data:r.data,title:r.title,index:Array.prototype.indexOf.call(n,e)}},canvasBase={setCanvas:function(e,t,a){let n=d3s.select(".tabular_container").append("canvas").attr("width",e).attr("height",t).style("animation","canvas_key 1s").style("WebkitAnimation","canvas_key 1s");return"col"==a&&d3s.select(".tabular_container").select("canvas").style("transform","rotate(90deg)"),n},setScale:function(e,t){return d3sc.scaleLinear().range([0,e-20]).domain([0,d3a.max(t)])},setPieScale:function(e){return d3sc.scaleLinear().range([0,2*Math.PI]).domain([0,e])},maxData:function(e){return d3a.max(e)}},barStyle=e=>{let t=e.createLinearGradient(0,200,0,0);t.addColorStop(0,"rgba(110,200,245,1)"),t.addColorStop(1,"rgba(40,125,250,1)");let a=e.createLinearGradient(0,200,0,0);return a.addColorStop(0,"rgba(135,135,135,1)"),a.addColorStop(1,"rgba(0,60,60,1)"),[t,a]},drawBarLine=(e,t,a,n,r)=>{e.beginPath(),e.moveTo(t,a),e.lineTo(n,r),e.closePath(),e.stroke()},drawBarMark=(e,t,a,n,r,l)=>{let i=e.getContext("2d");e.getContext("2d");i.strokeStyle="black";let o=2*parseInt(t/a);0==o&&(o=.5),i.textAlign="right";let s=0,d=r-10;for(i.fillText(0,0,d);s<t;){let e=s+o,a=parseInt(d*(1-e/t));i.moveTo(5,a),i.lineTo(n,a),i.strokeStyle="rgba(135,135,135,0.5)",i.stroke(),i.fillText(e,0,a,15),s+=o}},drawBarRect=(e,t,a,n,r,l,i,o)=>{let s=a/t.length*.8,d=a/t.length*.92;t.forEach(function(t,a){e.beginPath(),e.rect(d*a+10,n-15,s,-r(t)),a==i?(e.fillStyle=l[0],e.strokeStyle=l[0]):(e.fillStyle=l[1],e.strokeStyle=l[1]),e.fill(),e.closePath(),e.beginPath(),e.fillStyle="rgba(0,0,0,1)",e.textAlign="center",e.fillText(o[a],d*a+25,n,25),e.fillStyle="rgba(255,255,255,1)",e.fillText(t,d*a+25,n-r(t),25)})},drawBar=(e,t,a,n)=>{e=e.map(e=>parseFloat(e,10));let r=.6*document.body.clientWidth,l=r,i=canvasBase.setCanvas(r,l,a),o=i.node().getContext("2d"),s=canvasBase.setScale(l,e),d=canvasBase.maxData(e);o.translate(15,0),drawBarLine(o,5,l-15,r,l-15),drawBarLine(o,5,l-15,5,0),drawBarMark(i.node(),d,e.length,r,l);let c=barStyle(o);drawBarRect(o,e,r,l,s,c,t,n),o.scale(2,2)},bar=function(e,t,a,n){drawBar(e,t,a,n)},initBtn=function(e,t){let a=document.createElement("div"),n=document.createElement("div");className.addClass(a,"tab_vis_btn_container"),className.addClass(n,"tab_vis_btn");let r=document.createElement("div"),l=document.createElement("div");r.innerHTML="ROW",l.innerHTML="COL";return n.appendChild(r),n.appendChild(l),a.appendChild(n),document.body.appendChild(a),r.addEventListener("click",()=>{a.style.display="none";let n=rowData(e.ele,e.rowTitle);swapTabularVis(!1,t),bar(n.data,n.index,"row",n.title)}),l.addEventListener("click",()=>{a.style.display="none";let n=colData(e.ele,e.colTitle);swapTabularVis(!1,t),bar(n.data,n.index,"col",n.title)}),a},colTitle=e=>{if("object"==typeof e){let t=e.querySelector("tbody").children,a=[];for(let e=0;e<t.length;e++)a.push(t[e].children[0]);return a}console.error("the cell bind doesn't come from DOM ")},rowTitle=e=>{if("object"==typeof e){let t=e.querySelector("thead").querySelector("tr");return t=Array.from(t.children),Array.prototype.shift.call(t),t}console.error("the table bind doesn't come from DOM ")},initTable=function(e){let t=e.querySelector("tbody");className.addClass(t,"tab_vis_tbody");let a,n={ele:"",rowTitle:"",colTitle:""};this.initial?a=document.getElementById("tabular_vis"):(n.rowTitle=rowTitle(e),n.colTitle=colTitle(e),console.log("Insert Css done!"),a=createTabular(),this.initial=!0);let r=initBtn(n,a);t.addEventListener("click",()=>{let e=event||window.event,t=e.clientX,a=e.clientY;r.style.left=t+"px",r.style.top=a+"px",r.style.display="block",n.ele=e.target})},table_vis={initial:!1,vis:initTable};module.exports=table_vis;
