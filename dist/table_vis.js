"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var fontawesome=_interopDefault(require("@fortawesome/fontawesome")),faChartBar=_interopDefault(require("@fortawesome/fontawesome-free-solid/faChartBar")),faChartPie=_interopDefault(require("@fortawesome/fontawesome-free-solid/faChartPie")),faChartLine=_interopDefault(require("@fortawesome/fontawesome-free-solid/faChartLine")),d3a=require("d3-array"),d3s=require("d3-selection"),d3sc=require("d3-scale"),swapTabularVis=_interopDefault(require("swapTabularVis"));function styleInject(e,t){void 0===t&&(t={});var a=t.insertAt;if(e&&"undefined"!=typeof document){var n=document.head||document.getElementsByTagName("head")[0],r=document.createElement("style");r.type="text/css","top"===a&&n.firstChild?n.insertBefore(r,n.firstChild):n.appendChild(r),r.styleSheet?r.styleSheet.cssText=e:r.appendChild(document.createTextNode(e))}}var css="/*tbody*/\n.tab_vis_tbody{\n  cursor: pointer;\n}\n.tab_vis_btn_container{\n  cursor: pointer;\n  position: fixed;\n  width:60px;\n  height: 40px;\n  display: none;\n  box-shadow: 2px 2px 2px grey;\n}\n.tab_vis_btn{\n  position: relative;\n  width: 100%;\n  height: 100%;\n  background-color: #fff;\n  border: 1px solid #c1c1c1;\n  border-radius: 3px;\n}\n.tab_vis_btn:before,.tab_vis_btn:after{\n  content: ' ';\n  width: 0;\n  height: 0;\n  position: absolute;\n  top:4px;\n  left:-12px;\n  border: 6px solid transparent;\n  border-right-color:#fff;\n}\n.tab_vis_btn:before{\n  left:-13px;\n  border-right-color: #c1c1c1;\n}\n.tab_vis_btn div{\n  text-align: center;\n  height: 20px;\n  color:#777;\n  border-bottom:1px solid #d3d3d3;\n}\n.tab_vis_btn div:hover{\n  text-align: center;\n  height: 20px;\n  background: #d3d3d3;\n}\n";styleInject(css);const className={addClass:function(e,t){let a=e.className,n=a+(""==a?"":" ")+t;e.className=n},removeClass:function(e,t){let a=" "+e.className+" ",n=(a=a.replace(/(\s+)/gi," ")).replace(" "+t+" "," ");removedSpace=n.replace(/(^\s+)|(\s+$)/g,""),e.className=removedSpace}};var css$1="/*@keyframes tabular{ from{ width:0px} to { width:35%} }*/\n/*@-webkit-keyframes tabular{ from{ width:0} to { width:35%} }*/\n\n@keyframes canvaKey{\n  0% { opacity:0; }\n  25% { opacity:0.3; }\n  50% { opacity:0.5;}\n  100% {opacity:1; }}\n@-webkit-keyframes canvasKey{\n  0% { opacity:0; }\n  25% { opacity:0.3; }\n  50% { opacity:0.5;}\n  100% {opacity:1; }}\n.tabular_container_fluid{\n  display:inline-block;\n  position:fixed;\n  margin:auto;\n  top:0;\n  left:0;\n  bottom:0;\n  right:0;\n  width:0;\n  height:0;\n  background:rgba(255,255,255,0.9);\n}\n.tabular_container_fluid .tabular_container{\n  margin:0px auto;\n  text-align: center;\n}\n.tabular_container_fluid .tabular_container canvas{\n    zoom:0.5;\n}\n.tabular_container_fluid #tabular_vis_btn{\n  margin:0px auto;\n  text-align: center;\n  height: 10%;\n  width: 100%;\n  margin-bottom:10px;\n  overflow: hidden;\n}\n\n.tabular_container_fluid h3\n{\n  text-align: center;\n}\n";styleInject(css$1);const insertCss=()=>{fontawesome.library.add(faChartBar),fontawesome.library.add(faChartPie),fontawesome.library.add(faChartLine),console.log("Insert Tabluar-vis Css done!")},canvasBase={setCanvas:function(e,t,a){let n=d3s.select(".tabular_container").append("canvas").attr("width",e).attr("height",t).style("animation","canvasKey 1s").style("WebkitAnimation","canvasKey 1s");return"col"==a&&d3s.select(".tabular_container").select("canvas").style("transform","rotate(90deg)"),n},setScale:function(e,t){return d3sc.scaleLinear().range([0,e-20]).domain([0,d3a.max(t)])},setPieScale:function(e){return d3sc.scaleLinear().range([0,2*Math.PI]).domain([0,e])},maxData:function(e){return d3a.max(e)}},barStyle=e=>{let t=e.createLinearGradient(0,200,0,0);t.addColorStop(0,"rgba(110,200,245,1)"),t.addColorStop(1,"rgba(40,125,250,1)");let a=e.createLinearGradient(0,200,0,0);return a.addColorStop(0,"rgba(135,135,135,1)"),a.addColorStop(1,"rgba(0,60,60,1)"),[t,a]},drawBarLine=(e,t,a,n,r)=>{e.beginPath(),e.moveTo(t,a),e.lineTo(n,r),e.closePath(),e.stroke()},drawBarMark=(e,t,a,n,r,l,i)=>{let o=e.getContext("2d");o.strokeStyle="black";let d=2*parseInt(t/a);0==d&&(d=.5),o.textAlign="right";let s=0,c=r;for(o.fillText(0,0,c);s<t;){let e=s+d,t=r-l(e);o.moveTo(5,t),o.lineTo(n,t),o.strokeStyle="rgba(135,135,135,0.5)",o.stroke(),o.fillText(e,0,t,15),s+=d}},drawBarRect=(e,t,a,n,r,l,i,o)=>{let d=a/t.length*.8,s=a/t.length*.98;e.font="14px Arial",t.forEach(function(t,a){e.beginPath(),e.rect(s*a+10,n-20,d,-r(t)),a==i?(e.fillStyle=l[0],e.strokeStyle=l[0]):(e.fillStyle=l[1],e.strokeStyle=l[1]),e.fill(),e.closePath(),e.beginPath(),e.fillStyle="rgba(0,0,0,1)",e.textAlign="center",e.fillText(o[a],s*a+10+d/2,n,d),e.fillStyle="rgba(255,255,255,1)",e.fillText(t,s*a+10+d/2,n-r(t),d)})},drawBar=(e,t,a,n)=>{e=e.map(e=>parseFloat(e,10));let r=.6*document.body.clientWidth,l=r,i=document.querySelector(".tabular_container");i.firstElementChild&&i.removeChild(i.firstElementChild);let o=canvasBase.setCanvas(r,l,a),d=o.node().getContext("2d"),s=canvasBase.setScale(l-30,e),c=canvasBase.maxData(e);d.translate(15,0),drawBarLine(d,5,l-20,r,l-20),drawBarLine(d,5,l-20,5,0),drawBarMark(o.node(),c,e.length,r,l-20,s);let u=barStyle(d);drawBarRect(d,e,r,l,s,u,t,n),d.scale(2,2)},bar=function(e,t,a,n){drawBar(e,t,a,n)},drawPieText=(e,t,a,n,r,l)=>{e.fillStyle="white";let i=(r/l).toFixed(2),o=((l-r)/l).toFixed(2),d=(i=i.slice(2,4))+"%",s=(o=o.slice(2,4))+"%";e.fillText(d,t+.5*n,a+.2*n),e.fillText(s,t+.3*n,a-.2*n)},drawPieCircle=(e,t,a,n,r,l,i,o)=>{let d={x:.5*a,y:.5*n,radius:a<n?.3*a:.3*n,focusCircle:r(t[o])};e.beginPath(),e.moveTo(d.x,d.y),e.arc(d.x,d.y,d.radius,0,d.focusCircle),e.fillStyle=i[0],e.closePath(),e.fill(),e.beginPath(),e.moveTo(d.x,d.y),e.arc(d.x,d.y,d.radius,d.focusCircle,2*Math.PI),e.fillStyle=i[1],e.closePath(),e.fill(),drawPieText(e,d.x,d.y,d.radius,t[o],l)},pieStyle=e=>{let t=e.createLinearGradient(0,200,0,0);t.addColorStop(0,"rgba(110,200,245,1)"),t.addColorStop(1,"rgba(40,125,250,1)");let a=e.createLinearGradient(0,200,0,0);return a.addColorStop(0,"rgba(135,135,135,1)"),a.addColorStop(1,"rgba(0,60,60,1)"),[t,a]},drawPie=(e,t)=>{let a=0;e=e.map(e=>(a+=parseFloat(e,10),parseFloat(e,10)));let n=.6*document.body.clientWidth,r=n,l=document.querySelector(".tabular_container");l.firstElementChild&&l.removeChild(l.firstElementChild);let i=canvasBase.setCanvas(n,r).node().getContext("2d"),o=canvasBase.setPieScale(a);i.translate(15,0);let d=pieStyle(i);drawPieCircle(i,e,n,r,o,a,d,t),i.scale(2,2)},pie=function(e,t){drawPie(e,t)},drawLinePath=(e,t,a,n,r,l,i,o)=>{let d=a/t.length*.98;e.font="14px Arial",e.lineWidth="4",t.forEach(function(a,s){e.beginPath(),s!=t.length-1&&(e.moveTo(d*s+20,n-15-r(a)),e.lineTo(d*(s+1)+20,n-15-r(t[s+1])),e.strokeStyle=l[1]),e.closePath(),e.stroke(),e.beginPath(),s==i?(e.font="22px Arial",e.fillStyle=l[0],e.fillText(a,d*s+d/2,n-r(a)-20)):(e.fillStyle=l[1],e.fillText(a,d*s+d/2,n-r(a)-20)),e.closePath(),e.fill(),e.fillStyle=l[1],e.textAlign="center",e.font="14px Arial",e.fillText(o[s],d*s+d/2,n,d)})},lineStyle=()=>{return["rgba(40,125,250,1)","rgba(119,119,119,1)"]},drawLine=(e,t,a,n)=>{e=e.map(e=>parseFloat(e,10));let r=.6*document.body.clientWidth,l=r,i=document.querySelector(".tabular_container");i.firstElementChild&&i.removeChild(i.firstElementChild);let o=canvasBase.setCanvas(r,l,a),d=o.node().getContext("2d"),s=canvasBase.setScale(l-30,e),c=canvasBase.maxData(e);return d.translate(15,0),drawBarLine(d,5,l-20,r,l-20),drawBarLine(d,5,l-20,5,0),drawBarMark(o.node(),c,e.length,r,l-20,s),drawLinePath(d,e,r,l,s,["rgba(40,125,250,1)","rgba(119,119,119,1)"],t,n),d.scale(2,2),d},line=function(e,t,a,n){drawLine(e,t,a,n)},drawBox=(e,t,a,n,r,l,i,o)=>{e.beginPath(),e.strokeStyle="#000000",e.fillStyle="#000000",e.font="20px Arial";let d=n-r(i.max)-10,s=n-r(i.min)-10,c=n-r(i.middle)-10,u=n-r(i.q3)-10,f=r(i.q3-i.q1);e.moveTo(.4*a,d),e.lineTo(.5*a,d),e.fillText(i.max,.7*a,d),e.moveTo(.4*a,s),e.lineTo(.5*a,s),e.fillText(i.min,.7*a,s),e.moveTo(.45*a,d),e.lineTo(.45*a,s),e.stroke(),e.beginPath(),e.strokeStyle="#000",e.fillStyle="#FFF",e.fillRect(.3*a,u,.3*a,f),e.strokeRect(.3*a,u,.3*a,f),e.stroke(),e.beginPath(),e.fillStyle="#000",e.moveTo(.3*a,c),e.lineTo(.6*a,c),e.fillText("middle",.8*a,c),e.stroke(),e.beginPath(),e.strokeStyle="#108AEC",e.fillStyle="#108AEC";let b=n-r(t[l])-10;e.moveTo(.3*a,b),e.lineTo(.6*a,b),e.lineWidth="3",e.font="10",e.fillText(t[l],.8*a,b),e.stroke()},drawBoxPlot=(e,t,a,n,r)=>{e=e.map(e=>parseFloat(e,10));let l=.6*document.body.clientWidth,i=l,o=document.querySelector(".tabular_container");o.firstElementChild&&o.removeChild(o.firstElementChild);let d=canvasBase.setCanvas(l,i,n),s=d.node().getContext("2d"),c=canvasBase.setScale(i-30,e),u=canvasBase.maxData(e);s.translate(15,0),drawBarLine(s,5,i-20,5,0),drawBarMark(d.node(),u,e.length,l,i-20,c),drawBox(s,e,l,i,c,t,a),s.scale(2,2)},quickSort=e=>{if((e=e.map(e=>parseFloat(e,10))).length<=1)return e;{let t=Math.floor(e.length/2)-1,a=e.splice(t,1)[0],n=[],r=[];for(let t=0;t<e.length;t++)e[t]<a?n.push(e[t]):r.push(e[t]);return quickSort(n).concat([a],quickSort(r))}},calcPlot=function(e){let t=e,a=.25*((t=quickSort(t)).length+1),n=t[Math.floor(3*a)],r=t[Math.floor(a)];return{min:t[0],max:t[t.length-1],middle:t[Math.floor(t.length/2)],q3:n,q1:r}},boxPlot=function(e,t,a,n){let r=calcPlot(e);drawBoxPlot(e,t,r,a)},pointStyle=e=>{let t=e.createLinearGradient(0,200,0,0);t.addColorStop(0,"rgba(110,200,245,1)"),t.addColorStop(1,"rgba(40,125,250,1)");let a=e.createLinearGradient(0,200,0,0);return a.addColorStop(0,"rgba(135,135,135,1)"),a.addColorStop(1,"rgba(0,60,60,1)"),[t,a]},drawPointCol=(e,t,a,n,r,l,i,o)=>{let d=a/t.length,s=a/t.length*.92;t.forEach(function(t,a){e.beginPath(),e.arc(s*a+10+d/2,n-r(t),2*d,0,2*Math.PI),e.rect(s*a+10,n,d,-r(t)+2*d),a==i?(e.fillStyle=l[0],e.strokeStyle=l[0]):(e.fillStyle=l[1],e.strokeStyle=l[1]),e.fill(),e.closePath(),e.beginPath(),e.fillStyle="rgba(0,0,0,1)",e.textAlign="center",e.fillText(o[a],s*a+25,n+20,25),e.fillStyle="rgba(255,255,255,1)",e.fillText(t,s*a+25,n-r(t),25)})},drawPoint=(e,t,a,n)=>{e=e.map(e=>parseFloat(e,10));let r=.6*document.body.clientWidth,l=r,i=document.querySelector(".tabular_container");i.firstElementChild&&i.removeChild(i.firstElementChild);let o=canvasBase.setCanvas(r,l,a),d=o.node().getContext("2d"),s=canvasBase.setScale(l-30,e),c=canvasBase.maxData(e);d.translate(15,0),drawBarLine(d,5,l-20,r,l-20),drawBarLine(d,5,l-20,5,0),drawBarMark(o.node(),c,e.length,r,l-20,s);let u=pointStyle(d);drawPointCol(d,e,r,l-20,s,u,t,n),d.scale(2,2)},point=function(e,t,a,n){drawPoint(e,t,a,n)},createIcon=()=>{let e=[],t=document.createElement("i");className.addClass(t,"fa fa-chart-bar"),e.push(t);let a=document.createElement("i");className.addClass(a,"fa fa-chart-pie"),e.push(a);let n=document.createElement("i");return className.addClass(n,"fa fa-chart-line"),e.push(n),e},createDrawButton=()=>{let e=document.createElement("div");e.setAttribute("id","tabular_vis_btn");let t=createIcon(),a=document.createElement("button");a.appendChild(t[0]),a.addEventListener("click",()=>{let e=document.querySelector(".tabular_container_fluid"),t=e.getAttribute("data-on"),a=e.getAttribute("data-index"),n=e.getAttribute("data-title"),r=e.getAttribute("data-status");bar(t.split(","),a,r,n.split(","))}),e.appendChild(a);let n=document.createElement("button");n.appendChild(t[1]),n.addEventListener("click",()=>{let e=document.querySelector(".tabular_container_fluid"),t=e.getAttribute("data-on"),a=e.getAttribute("data-index");pie(t.split(","),a)}),e.appendChild(n);let r=document.createElement("button");r.appendChild(t[2]),r.addEventListener("click",function(){let e=document.querySelector(".tabular_container_fluid"),t=e.getAttribute("data-on"),a=e.getAttribute("data-index"),n=e.getAttribute("data-title"),r=e.getAttribute("data-status");line(t.split(","),a,r,n.split(","))}),e.appendChild(r);let l=document.createElement("button");l.innerHTML="boxPlot",l.addEventListener("click",()=>{let e=document.querySelector(".tabular_container_fluid"),t=e.getAttribute("data-on"),a=e.getAttribute("data-index"),n=e.getAttribute("data-title"),r=e.getAttribute("data-status");boxPlot(t.split(","),a,r,n.split(","))}),e.appendChild(l);let i=document.createElement("button");return i.innerHTML="point",i.addEventListener("click",()=>{let e=document.querySelector(".tabular_container_fluid"),t=e.getAttribute("data-on"),a=e.getAttribute("data-index"),n=e.getAttribute("data-title"),r=e.getAttribute("data-status");point(t.split(","),a,r,n.split(","))}),e.appendChild(i),e},createTabular=()=>{let e=document.createElement("div");className.addClass(e,"tabular_container_fluid");let t=document.createElement("div");return t.setAttribute("id","tabular_vis"),className.addClass(t,"tabular_container"),t.addEventListener("click",()=>{e.removeAttribute("style"),e.style.width="0",e.removeChild(e.querySelector("h3")),t.removeChild(t.firstElementChild)}),e.appendChild(createDrawButton()),e.appendChild(t),document.body.appendChild(e),console.log("Create Tabular div done"),e},regData=e=>{let t=[],a=[],n=new RegExp(/^\d+\.?\d*$/);for(let r=0;r<e[0].length;){let l=e[0][r].innerHTML.replace(/\,/g,"");n.test(l)?(t.push(l),a.push(e[1][r].innerHTML),r++):(e[0].splice(r,1),e[1].splice(r,1))}return{data:t,title:a}},colData=function(e,t){let a=e.parentNode,n=a.parentNode.children,r=[],l=Array.prototype.indexOf.call(a.children,e);for(let e=0;e<n.length;e++)r.push(n[e].children[l]);let i=regData([r,t]);return{data:i.data,title:i.title,index:Array.prototype.indexOf.call(n,a)}},rowData=function(e,t){let a=e.parentNode,n=Array.from(a.children);n.shift();let r=regData([n,t]);return{data:r.data,title:r.title,index:Array.prototype.indexOf.call(n,e)}},initHead=()=>{let e=document.createElement("h3"),t=document.querySelector(".tabular_container_fluid");return e.innerHTML=t.getAttribute("data-head"),e},initBtn=function(e,t){let a=document.createElement("div"),n=document.createElement("div");className.addClass(a,"tab_vis_btn_container"),className.addClass(n,"tab_vis_btn");let r=document.createElement("div"),l=document.createElement("div");r.innerHTML="ROW",l.innerHTML="COL";return n.appendChild(r),n.appendChild(l),a.appendChild(n),document.body.appendChild(a),r.addEventListener("click",()=>{a.style.display="none";let n=rowData(e.ele,e.rowTitle),r=colData(e.ele,e.colTitle).index;t.setAttribute("data-on",n.data),t.setAttribute("data-title",n.title),t.setAttribute("data-index",n.index),t.setAttribute("data-head",e.colTitle[r].innerHTML),t.setAttribute("data-status","row"),t.querySelector("h3")?t.querySelector("h3").innerHTML=e.colTitle[r].innerHTML:t.insertBefore(initHead(),t.querySelector(".tabular_container")),swapTabularVis(!1,t),bar(n.data,n.index,"row",n.title)}),l.addEventListener("click",()=>{a.style.display="none";let n=colData(e.ele,e.colTitle),r=rowData(e.ele,e.rowTitle).index;t.setAttribute("data-on",n.data),t.setAttribute("data-title",n.title),t.setAttribute("data-index",n.index),t.setAttribute("data-status","col"),t.setAttribute("data-head",e.rowTitle[r].innerHTML),t.querySelector("h3")?t.querySelector("h3").innerHTML=e.rowTitle[r].innerHTML:t.insertBefore(initHead(),t.querySelector(".tabular_container")),swapTabularVis(!1,t),bar(n.data,n.index,"col",n.title)}),a},colTitle=e=>{if("object"==typeof e){let t=e.querySelector("tbody").children,a=[];for(let e=0;e<t.length;e++)a.push(t[e].children[0]);return a}console.error("the cell bind doesn't come from DOM ")},rowTitle=e=>{if("object"==typeof e){let t=e.querySelector("thead").querySelector("tr");return t=Array.from(t.children),Array.prototype.shift.call(t),t}console.error("the table bind doesn't come from DOM ")},initTable=function(e){let t=e.querySelector("tbody");className.addClass(t,"tab_vis_tbody");let a,n={ele:"",rowTitle:"",colTitle:""};this.initial?a=document.querySelector(".tabular_container_fluid"):(n.rowTitle=rowTitle(e),n.colTitle=colTitle(e),fontawesome.library.add(faChartBar),fontawesome.library.add(faChartPie),fontawesome.library.add(faChartLine),console.log("Insert Tabluar-vis Css done!"),a=createTabular(),this.initial=!0);let r=initBtn(n,a);t.addEventListener("click",()=>{let e=event||window.event,t=e.clientX,a=e.clientY;r.style.left=t+"px",r.style.top=a+"px",r.style.display="block",n.ele=e.target})},table_vis={initial:!1,vis:initTable};module.exports=table_vis;
