"use strict";var d3a=require("d3-array"),d3s=require("d3-selection"),d3sc=require("d3-scale");function styleInject(e,t){void 0===t&&(t={});var a=t.insertAt;if(e&&"undefined"!=typeof document){var l=document.head||document.getElementsByTagName("head")[0],r=document.createElement("style");r.type="text/css","top"===a&&l.firstChild?l.insertBefore(r,l.firstChild):l.appendChild(r),r.styleSheet?r.styleSheet.cssText=e:r.appendChild(document.createTextNode(e))}}var css=".vis_tbody{\n  cursor: pointer;\n}\n";styleInject(css);const className={addClass:function(e,t){let a=e.className,l=a+(""==a?"":" ")+t;e.className=l},removeClass:function(e,t){let a=" "+e.className+" ",l=(a=a.replace(/(\s+)/gi," ")).replace(" "+t+" "," ");removedSpace=l.replace(/(^\s+)|(\s+$)/g,""),e.className=removedSpace}};let tBody;const initTable=function(e){tBody=e.querySelector("tbody"),className.addClass(tBody,"vis_tbody")},rowBase=(e,t)=>{if("object"==typeof e){let a=e.getElementsByTagName("tbody")[0],l=e.getElementsByTagName("thead")[0].getElementsByTagName("tr")[0],r=a.getElementsByTagName("tr")[t-1];return[Array.from(r.children),Array.from(l.children)]}console.error("the table bind doesn't come from DOM ")},colBase=(e,t)=>{if("object"==typeof e){let a=e.getElementsByTagName("tbody")[0].children,l=[],r=[];for(let e=0;e<a.length;e++)l.push(a[e].children[t]),r.push(a[e].children[0]);return[l,r]}console.error("the cell bind doesn't come from DOM ")},base=(e,t,a)=>{let l;return"row"==t?l=rowBase(e,a):"col"==t?l=colBase(e,a):void console.error("please type row or col as direction")},regBase=e=>{let t=[],a=[],l=new RegExp(/^\d+\.?\d*$/);for(let r=0;r<e[0].length;){let n=e[0][r].innerHTML.replace(/\,/g,"");l.test(n)?(t.push(n),a.push(e[1][r].innerHTML),r++):(e[0].splice(r,1),e[1].splice(r,1))}return[t,a]},canvasBase={setCanvas:function(e,t,a){let l=d3s.select(".tabular_container").append("canvas").attr("width",e).attr("height",t).style("animation","canvas_key 1s").style("WebkitAnimation","canvas_key 1s");return"col"==a&&d3s.select(".tabular_container").select("canvas").style("transform","rotate(90deg)"),l},setScale:function(e,t){return d3sc.scaleLinear().range([0,e-20]).domain([0,d3a.max(t)])},setPieScale:function(e){return d3sc.scaleLinear().range([0,2*Math.PI]).domain([0,e])},maxData:function(e){return d3a.max(e)}},barStyle=e=>{let t=e.createLinearGradient(0,200,0,0);t.addColorStop(0,"rgba(110,200,245,1)"),t.addColorStop(1,"rgba(40,125,250,1)");let a=e.createLinearGradient(0,200,0,0);return a.addColorStop(0,"rgba(135,135,135,1)"),a.addColorStop(1,"rgba(0,60,60,1)"),[t,a]},drawBarLine=(e,t,a,l,r)=>{e.beginPath(),e.moveTo(t,a),e.lineTo(l,r),e.closePath(),e.stroke()},drawBarMark=(e,t,a,l,r,n)=>{let i=e.getContext("2d");e.getContext("2d");i.strokeStyle="black";let o=2*parseInt(t/a);0==o&&(o=.5),i.textAlign="right";let s=0,d=r-10;for(i.fillText(0,0,d);s<t;){let e=s+o,a=parseInt(d*(1-e/t));i.moveTo(5,a),i.lineTo(l,a),i.strokeStyle="rgba(135,135,135,0.5)",i.stroke(),i.fillText(e,0,a,15),s+=o}},drawBarRect=(e,t,a,l,r,n,i,o)=>{let s=a/t.length*.8,d=a/t.length*.92;t.forEach(function(t,a){e.beginPath(),e.rect(d*a+10,l-15,s,-r(t)),a==i?(e.fillStyle=n[0],e.strokeStyle=n[0]):(e.fillStyle=n[1],e.strokeStyle=n[1]),e.fill(),e.closePath(),e.beginPath(),e.fillStyle="rgba(0,0,0,1)",e.textAlign="center",e.fillText(o[a],d*a+25,l,25),e.fillStyle="rgba(255,255,255,1)",e.fillText(t,d*a+25,l-r(t),25)})},drawBar=(e,t,a,l)=>{e=e.map(e=>parseFloat(e,10));let r=.6*document.body.clientWidth,n=r,i=canvasBase.setCanvas(r,n,a),o=i.node().getContext("2d"),s=canvasBase.setScale(n,e),d=canvasBase.maxData(e);o.translate(15,0),drawBarLine(o,5,n-15,r,n-15),drawBarLine(o,5,n-15,5,0),drawBarMark(i.node(),d,e.length,r,n);let c=barStyle(o);drawBarRect(o,e,r,n,s,c,t,l),o.scale(2,2)};var css$1="@keyframes tabular{ from{ width:0px} to { width:30%} }\n@-webkit-keyframes tabular{ from{ width:0} to { width:30%} }\n@keyframes canvas_key{ from{ height:0} to { height:100%} }\n@-webkit-keyframes canvas_key{ from{ height:0} to { height:100%} }\n.tabular_container {\n  display:inline-block;position:fixed;\n  margin:auto;top:0;\n  left:0;\n  bottom:0;\n  right:0;\n  width:0;\n  height:0;\n  background:rgba(255,255,255,0.7);\n}\n.tabular_container canvas{\n    zoom:0.5;\n  }\n";styleInject(css$1);const insertCss=()=>{console.log("Insert Css done!")},createTabular=()=>{let e=document.createElement("div");return e.setAttribute("id","tabular_vis"),className.addClass(e,"tabular_container"),e.addEventListener("click",()=>{e.removeAttribute("style"),e.style.width="0",e.removeChild(e.firstElementChild)}),document.body.appendChild(e),console.log("Create Tabular div done"),e},swapTabularVis=(e,t)=>e&&"0px"!=t.style.width?(t.removeAttribute("style"),t.style.width="0",t.removeChild(t.firstElementChild),!1):(t.style.width=.3*document.body.clientWidth+"px",t.style.height=.3*document.body.clientWidth+"px",t.style.animation="tabular 1s",t.style.WebkitAnimation="tabular 1s",t.style.cursor="pointer",!0),bar=function(e,t,a){let l,r=base(e,t,a)[0],n=base(e,t,a)[1],i=[],o=!1;this.initial?l=document.getElementById("tabular_vis"):(insertCss(),l=createTabular(),this.initial=!0);let s=regBase([r,n])[0];n=regBase([r,n])[1];for(let e=0;e<r.length;e++){i.push(s[e]);let a=Array.prototype.indexOf.call(r,r[e]);r[e].style.cursor="pointer",r[e].addEventListener("click",()=>{(o=swapTabularVis(o,l))&&drawBar(i,a,t,n)},!0)}},drawLinePath=(e,t,a,l,r,n,i,o)=>{t.forEach(function(s,d){e.beginPath(),d!=t.length-1&&(e.moveTo(a/t.length*d*.92+20,l-15-r(s)),e.lineTo(a/t.length*(d+1)*.92+20,l-15-r(t[d+1])),e.strokeStyle=n[1]),e.closePath(),e.stroke(),e.beginPath(),d==i?(e.arc(a/t.length*d*.92+20,l-15-r(s),10,0,2*Math.PI),e.fillStyle=n[0]):(e.arc(a/t.length*d*.92+20,l-15-r(s),5,0,2*Math.PI),e.fillStyle=n[1]),e.closePath(),e.fill(),e.fillStyle=n[1],e.textAlign="center",e.fillText(o[d],a/t.length*d*.92+25,l,25),e.fillText(s,a/t.length*d*.92+25,l-r(s),25)})},lineStyle=()=>{return["rgba(40,125,250,1)","rgba(0,0,0,1)"]},drawLine=(e,t,a,l)=>{e=e.map(e=>parseFloat(e,10));let r=.6*document.body.clientWidth,n=r,i=canvasBase.setCanvas(r,n,a),o=i.node().getContext("2d"),s=canvasBase.setScale(n,e),d=canvasBase.maxData(e);return o.translate(15,0),drawBarLine(o,5,n-15,r,n-15),drawBarLine(o,5,n-15,5,0),drawBarMark(i.node(),d,e.length,r,n),drawLinePath(o,e,r,n,s,["rgba(40,125,250,1)","rgba(0,0,0,1)"],t,l),o.scale(2,2),o},line=function(e,t,a){let l,r=base(e,t,a)[0],n=base(e,t,a)[1],i=[],o=!1;this.initial?l=document.getElementById("tabular_vis"):(insertCss(),l=createTabular(),this.initial=!0);let s=regBase([r,n])[0];n=regBase([r,n])[1];for(let e=0;e<r.length;e++){i.push(s[e]);let a=Array.prototype.indexOf.call(r,r[e]);r[e].style.cursor="pointer",r[e].addEventListener("click",()=>{(o=swapTabularVis(o,l))&&drawLine(i,a,t,n)},!0)}},drawPieText=(e,t,a,l,r,n)=>{e.fillStyle="white";let i=(r/n).toFixed(2),o=((n-r)/n).toFixed(2),s=(i=i.slice(2,4))+"%",d=(o=o.slice(2,4))+"%";e.fillText(s,t+.5*l,a+.2*l),e.fillText(d,t+.3*l,a-.2*l)},drawPieCircle=(e,t,a,l,r,n,i,o)=>{let s={x:.5*a,y:.5*l,radius:a<l?.3*a:.3*l,focusCircle:r(t[o])};e.beginPath(),e.moveTo(s.x,s.y),e.arc(s.x,s.y,s.radius,0,s.focusCircle),e.fillStyle=i[0],e.closePath(),e.fill(),e.beginPath(),e.moveTo(s.x,s.y),e.arc(s.x,s.y,s.radius,s.focusCircle,2*Math.PI),e.fillStyle=i[1],e.closePath(),e.fill(),drawPieText(e,s.x,s.y,s.radius,t[o],n)},pieStyle=e=>{let t=e.createLinearGradient(0,200,0,0);t.addColorStop(0,"rgba(110,200,245,1)"),t.addColorStop(1,"rgba(40,125,250,1)");let a=e.createLinearGradient(0,200,0,0);return a.addColorStop(0,"rgba(135,135,135,1)"),a.addColorStop(1,"rgba(0,60,60,1)"),[t,a]},drawPie=(e,t)=>{let a=0;e=e.map(e=>(a+=parseFloat(e,10),parseFloat(e,10)));let l=.6*document.body.clientWidth,r=l,n=canvasBase.setCanvas(l,r).node().getContext("2d"),i=canvasBase.setPieScale(a);n.translate(15,0);let o=pieStyle(n);drawPieCircle(n,e,l,r,i,a,o,t),n.scale(2,2)},pie=function(e,t,a){let l,r=base(e,t,a)[0],n=base(e,t,a)[1],i=[],o=!1;this.initial?l=document.getElementById("tabular_vis"):(insertCss(),l=createTabular(),this.initial=!0);let s=regBase([r,n])[0];n=regBase([r,n])[1];for(let e=0;e<r.length;e++){i.push(s[e]);let t=Array.prototype.indexOf.call(r,r[e]);r[e].style.cursor="pointer",r[e].addEventListener("click",()=>{(o=swapTabularVis(o,l))&&drawPie(i,t)},!0)}},pointStyle=e=>{let t=e.createLinearGradient(0,200,0,0);t.addColorStop(0,"rgba(110,200,245,1)"),t.addColorStop(1,"rgba(40,125,250,1)");let a=e.createLinearGradient(0,200,0,0);return a.addColorStop(0,"rgba(135,135,135,1)"),a.addColorStop(1,"rgba(0,60,60,1)"),[t,a]},drawPointCol=(e,t,a,l,r,n,i,o)=>{let s=a/t.length*.1,d=a/t.length*.92;t.forEach(function(t,a){e.beginPath(),e.arc(d*a+10+s/2,l-15-r(t),2*s,0,2*Math.PI),e.rect(d*a+10,l-15,s,-r(t)+2*s),a==i?(e.fillStyle=n[0],e.strokeStyle=n[0]):(e.fillStyle=n[1],e.strokeStyle=n[1]),e.fill(),e.closePath(),e.beginPath(),e.fillStyle="rgba(0,0,0,1)",e.textAlign="center",e.fillText(o[a],d*a+25,l,25),e.fillStyle="rgba(255,255,255,1)",e.fillText(t,d*a+25,l-r(t),25)})},drawPoint=(e,t,a,l)=>{e=e.map(e=>parseFloat(e,10));let r=.6*document.body.clientWidth,n=r,i=canvasBase.setCanvas(r,n,a),o=i.node().getContext("2d"),s=canvasBase.setScale(n,e),d=canvasBase.maxData(e);o.translate(15,0),drawBarLine(o,5,n-15,r,n-15),drawBarLine(o,5,n-15,5,0),drawBarMark(i.node(),d,e.length,r,n);let c=pointStyle(o);drawPointCol(o,e,r,n,s,c,t,l),o.scale(2,2)},point=function(e,t,a){let l,r=base(e,t,a)[0],n=base(e,t,a)[1],i=[],o=!1;this.initial?l=document.getElementById("tabular_vis"):(insertCss(),l=createTabular(),this.initial=!0);let s=regBase([r,n])[0];n=regBase([r,n])[1];for(let e=0;e<r.length;e++){i.push(s[e]);let a=Array.prototype.indexOf.call(r,r[e]);r[e].style.cursor="pointer",r[e].addEventListener("click",()=>{(o=swapTabularVis(o,l))&&drawPoint(i,a,t,n)},!0)}},drawBox=(e,t,a,l,r,n,i,o)=>{e.beginPath(),e.strokeStyle="#000000",e.fillStyle="#000000";let s=l-r(i.max)-10,d=l-r(i.min)-10,c=l-r(i.middle)-10,h=l-r(i.q3)-10,g=r(i.q3-i.q1);e.moveTo(.4*a,s),e.lineTo(.5*a,s),e.fillText(i.max,.7*a,s),e.moveTo(.4*a,d),e.lineTo(.5*a,d),e.fillText(i.min,.7*a,d),e.moveTo(.45*a,s),e.lineTo(.45*a,d),e.stroke(),e.beginPath(),e.strokeStyle="#000",e.fillStyle="#FFF",e.fillRect(.3*a,h,.3*a,g),e.strokeRect(.3*a,h,.3*a,g),e.stroke(),e.beginPath(),e.fillStyle="#000",e.moveTo(.3*a,c),e.lineTo(.6*a,c),e.fillText("middle",.8*a,c),e.stroke(),e.beginPath(),e.strokeStyle="#108AEC",e.fillStyle="#108AEC";let u=l-r(t[n])-10;e.moveTo(.3*a,u),e.lineTo(.6*a,u),e.lineWidth="3",e.font="10",e.fillText(t[n],.8*a,u),e.stroke()},drawBoxPlot=(e,t,a,l,r)=>{e=e.map(e=>parseFloat(e,10));let n=.6*document.body.clientWidth,i=n,o=canvasBase.setCanvas(n,i,l),s=o.node().getContext("2d"),d=canvasBase.setScale(i,e),c=canvasBase.maxData(e);s.translate(15,0),drawBarLine(s,5,i-15,5,0),drawBarMark(o.node(),c,e.length,n,i),drawBox(s,e,n,i,d,t,a),s.scale(2,2)},quickSort=e=>{if((e=e.map(e=>parseFloat(e,10))).length<=1)return e;{let t=Math.floor(e.length/2)-1,a=e.splice(t,1)[0],l=[],r=[];for(let t=0;t<e.length;t++)e[t]<a?l.push(e[t]):r.push(e[t]);return quickSort(l).concat([a],quickSort(r))}},calcPlot=function(e){let t=e,a=.25*((t=quickSort(t)).length+1),l=t[Math.floor(3*a)],r=t[Math.floor(a)];return{min:t[0],max:t[t.length-1],middle:t[Math.floor(t.length/2)],q3:l,q1:r}},boxPlot=function(e,t,a){let l,r=base(e,t,a)[0],n=base(e,t,a)[1],i=[],o=!1;this.initial?l=document.getElementById("tabular_vis"):(insertCss(),l=createTabular(),this.initial=!0);let s=regBase([r,n])[0];n=regBase([r,n])[1];let d=calcPlot(s);for(let e=0;e<r.length;e++){i.push(s[e]);let a=Array.prototype.indexOf.call(r,r[e]);r[e].style.cursor="pointer",r[e].addEventListener("click",()=>{(o=swapTabularVis(o,l))&&drawBoxPlot(i,a,d,t)},!0)}},table_vis={initial:!1,vis:initTable,bar:bar,line:line,pie:pie,point:point,boxPlot:boxPlot};module.exports=table_vis;
